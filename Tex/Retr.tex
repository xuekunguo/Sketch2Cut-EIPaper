

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{候选模型搜索}
本章中，我们介绍RC-$k$NNG如何从未做预分割的模型数据库内快速地精确地搜索出与代理模型相匹配候选部件。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{代理模型创建}
与~\cite{Funkhouser2004}类似，我们使用三维代理模型从数据库内搜索部件并辅助部件组合。
我们提供三种基本代理模型，从而使用户更容易表达造型意图。
当然，用户输入的草图也可直接用于从数据库内搜索部件。

我们提供的三种基本代理模型是：广义球体，广义柱体，薄板模型（如图\ref{FigProxy}）。
广义球体通过Nealen等人~\cite{AndrewNealen2007}的方法生成。
广义柱体通过两笔生成：在当前模型上画一个圆环表示柱体底座，然后用一条曲线指示中心线。中心线位于用户视线方向与圆球起点定义的空间平面上。
广义柱体的一端可以放缩，得到圆锥或圆台。
要得生成薄板型代理模型，用户需要首先在当前模型上画一条曲线，再绘制出其轮廓。
该轮廓位于用户视线方向与曲线起点定义的空间平面上。
我们的系统允许用户对代理模型施加各种操作，包括放缩，切割，托拽顶点等。
通过如上方法生成的各种代理模型见图\ref{FigProxy}及本文视频。
%--------------------------
\begin{figure}\centering
\includegraphics[width=\linewidth]{./Mat/Proxy.pdf}
\caption[三种基础代理模型]{三种基础代理模型。（a）广义球体。（b）广义柱体。（c）薄板模型。}\label{FigProxy}
\end{figure}

用户创建代理模型过程中，系统记录每次操作的视角及操作前后代理模型的体积变化。
代理模型建成后，我们提取代理模型在体积变化最大的视角下的二维轮廓，用于描述用户的建模意图（期望的部件）。
这里的体积变化指画草图前后代理模型的体积之差。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{轮廓描述符}\label{SubSecCD}
查询轮廓（代理模型轮廓）整体做为一个轮廓段。模型轮廓在每个尺度下都由若干轮廓段构成（见\ref{SecRCKNNG}节）。
模型轮廓的轮廓段与查询轮廓相匹配，从而得到查询轮廓与模型轮廓的局部匹配。

为了比较两个轮廓段，我们为它们计算轮廓描述符。我们采用Riemenschneider等人~\cite{Riemenschneider2010}提出的角度矩阵做为轮廓描述符。
该描述符描述了轮廓段上采样点间的空间分布。

一个轮廓段内有$m=21$个采样点。给一对采样点$\left(b_i, b_j \right)$，我们计算角度值$\alpha_{ij}$：
\[{\alpha _{ij}} = \left\{ {\begin{array}{*{20}{c}}
{\left\langle {\overline {{b_i}{b_j}} ,\overline {{b_i}{b_{i + \Delta }}} } \right\rangle } & {\text{if~} i < j,}  \\
{\left\langle {\overline {{b_i}{b_j}} ,\overline {{b_i}{b_{i - \Delta }}} } \right\rangle } & {\text{if~} i > j,}  \\
0 & {\text{if~} \left\| {i - j} \right\| \le \Delta }  \\
\end{array}} \right.\]
其中，$\delta=2$是偏移量，$\left\langle l_1, l_2 \right\rangle$代表直线$l_1$与$l_2$间的夹角。轮廓描述符即为该角度值构成的矩阵$A$（$A_{ij}=\alpha_{ij}$）。
两个轮廓段$S$与$T$间的距离是两轮廓段的角度矩阵$A^S$与$A^T$的欧式距离：
\[ D(S, T) = \frac{1}{m^2} \sum_{i = 1}^m \sum_{j = 1}^m \left( A^S_{ij} - A^T_{ij} \right)^2\]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{模型搜索}
%我们需要先找到$c=9$个与代理模型匹配上的数据库模型（称为候选模型），然后再从候选模型中提取出候选部件建议给用户。
%为此，我们在RC-$k$NNG内找到很多（$21c$）匹配轮廓段，得到对应的匹配模型并为它们计算排序分数。
%得分最高的$c$个模型会显示给用户。
%
%为得到这些匹配的轮廓段，我们首先将查询轮廓段与RC-$k$NNG的所有种子轮廓段比较。
%比较结果存储至优先队列中，与查询轮廓段间距最小的轮廓段排在队首。
%然后，以最好优先方式（Best-first Search）遍历整个RC-$k$NNG。
%遍历过程中，首先优先队列队首出队并加入匹配轮廓段集合，该队首的所有邻居与查询轮廓段做匹配并入队。
%该过程一直进行，直至匹配轮廓段集合内元素数目为$21c$。
%
%对数据库模型，我们按如下方法计算其做为候选模型的分数：
%\[ s = \frac{\alpha }{t}\sum\limits_{i = 1}^t {{D_i}}  + \frac{\beta }{t}, \]
%其中，$t$是属于该模型的匹配轮廓段数目，$D_i$是第$i$个匹配轮廓段与查询轮廓段间距，$\alpha = 0.95$，$\beta = 0.05$。

给三维代理部件与数据库模型，我们的目标是在数据库模型上找到候选部件，该候选部件与三维代理部件最相似，通过基于超面片图的多视角模型匹配方法。
我们首先找到候选三维部件的二维轮廓，通过将代理轮廓与数据库轮廓做匹配。三维候选部件的超面片然后被指示出来，通过graph-cut技术，在超面片图上。

\textbf{轮廓匹配} 轮廓匹配通过轮廓对应的轮廓描述符匹配实现。给一个通过三维代理轮廓$C$；及数据库模型轮廓$S$；
我们的目标是在$S$上找到与$C$最匹配的部分$F$，使其与$C$最相似。该问题形式化如下：
%\[V\left( {{\bf{A}},{\bf{A}}'} \right) = \mathop {\min }\limits_k \frac{1}{{{N^2}}}\sum\limits_{i = 0}^{N - 1} {\sum\limits_{j = 0}^{N - 1} {{{\left( {{A_{\left[ {k + i,k + j} \right]}} - A_{\left[ {i,j} \right]}^'} \right)}^2}} } ,\]
其中，$\bf A$是$S$的轮廓描述符，大小为$M \times M$，${\bf A}'$是$C$的轮廓描述符，大小为$N \times N$（$N \le M$）。
$A_{\left[,\right]}$是矩阵的元素。$V \left({\bf A}, {\bf A'} \right)$是匹配分数，指出$C$与$F$的差异程度。

\textbf{候选轮廓段指认} 三维代理部件轮廓与数据库模型轮廓的匹配结果组织为$\left\| {{\Theta _M}} \right\|$个匹配结果组内，根据采样距离。
我们观察到，在相似视角（如，邻近视角，对称视角，相对视角）下的数据库模型轮廓具有很强的相似性。因此，在每一个匹配结果组内必然有组最低分数的匹配结果。
给一个代理轮廓$C$，与一组数据库模型轮廓$\Xi  = \left\{ {E_{{S_i}}^{{\theta _j}}\left| {{S_i} \in {\Gamma _M},{\theta _j} \in {\Theta _M}} \right.} \right\}$
，得到从同一模型的不同视角${{\Gamma _M}}$，不同采样距离$\Theta_M$。最好匹配结果组选择问题形式化如下：
\[\mathop {\min }\limits_{{\theta _i} \in {\Theta _M}} \sum\limits_{j = 1}^{j = L} {V\left( {{\bf{A}}_{E_{{S_k}}^{{\theta _i}}}^j,{\bf{A}}'} \right),} \]
其中，${{\bf A}_{E_{{S_k}}^{{\theta _i}}}^j}$是数据库模型轮廓$S_k$的轮廓描述符，其产生最好的第$j$个匹配结果，在采样距离为$\theta_i$的所有情况下。
${\bf A}'$是$C$的轮廓描述符。产生最佳匹配结果组的采样距离$\theta_i$是最佳采样距离。

我们选择出得到最低的3个匹配结果，从最佳匹配结果组内，并得到候选轮廓段。得到候选轮廓段的视角是候选视角。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{部件指认}
%--------------------------
\begin{figure}\centering
\includegraphics[width=1.0\linewidth]{./Mat/PartIden.pdf}
\caption{三维候选部件指认技术流程。给一个候选轮廓（蓝色（a）），我们首先计算OSF obj-prob（b）。obj-prob的值映射至不同颜色。红色表示高值。绿色表示低值。
然后，ISF obj-prob计算出来（c）。最后，三维候选部件的超面片通过graph-cut技术指认出来（d）。}\label{FigPartIden}
\end{figure}
给一个候选轮廓及其数据库模型，该数据库模型表示为超面片图表示形式。我们的目标是找到候选三维部件的超面片图，该候选部件在候选视角下与候选轮廓最相似（如图~\ref{FigPartIden}）。
我们将三维候选部件的指认问题形式化为子图搜索问题，目标函数为：
\[\mathop {\min }\limits_L \left( {\sum\limits_{{v_i} \in V} {{D_{{v_i}}}\left( {{L_{{v_i}}}} \right) + \sum\limits_{\left( {{v_i},{v_j}} \right) \in E} {{S_{{v_i},{v_j}}}\left( {{L_{{v_i}}},{L_{{v_j}}}} \right)} } } \right),\]
其中，超面片图$G = \left( V, E \right)$，$V$表示顶点集合，$E$表示边集合。$L = \left\{ {{L_{{v_i}}}|{v_i} \in V} \right\}$是超面片图$G$的一个标记。
$D_{v_i} \left( L_{v_i} \right)$是数值项，计算将标志$L_{v_i}$置给$v_i$的能量耗费。$S_{v_i, v_j} \left(L_{v_i}, L_{v_j} \right)$是光滑项，鼓励相邻顶点$v_i$与$v_j$的空间一致性。

该目标函数采用min-cut/max-flow技术求解~\cite{Boykov2004}。n-links的容量是图内边的权重。t-links的容量定义为：
\[{D_{{v_i}}}\left( 1 \right) =  - \ln \Pr \left( {{I_{{v_i}}}|'obj'} \right),\]
\[{D_{{v_i}}}\left( 0 \right) =  - \ln \left( {1 - \Pr \left( {{I_{{v_i}}}|'obj'} \right)} \right),\]
其中，$Pr \left( I_{v_i} | 'obj' \right)$（obj-prob）表示$v_i$属于三维候选部件的概率。obj-prob的计算方法在接下来介绍。

{Outer SF obj-prob计算} 对outer SF（OSF），其轮廓与模型轮廓有重合，其obj-prob通过其与候选三维部件的重合程度决定。
%对OSF $v$，其obj-prob定义为：
%\[\Pr \left( {{I_v}|'obj'} \right) = \frac{{\left| {\mathbf K} \right|}}{{\left| {\mathbf O} \right|}},\]
%其中$\mathbf O$是OSF轮廓的

{Inner SF obj-prob计算} 对一个超面片图来讲，除了Outer SF就是Inner SF（ISF）。我们认为，在整张图内，OSF与ISF的obj-prob相一致。
因此，我们让OSF的obj-prob流入ISF，根据SF间的一致性。obj-prob流问题形式化为最小二乘问题：
\[{\bf{AX}} = {\bf{b}},\]
条件为：
\[{\bf{X}} \ge 0,\]
其中，${\bf{A}} = {\bf{I}} - {\bf{A}}'$，$\bf A'$是带权重的相邻矩阵，在ISFs之间。$\bf X$是ISF的概率。${\bf b} = {\bf B Y }$，其中$\bf B$是ISF与OSF间的带权相邻矩阵，
$\bf Y$是OSF的概率。


