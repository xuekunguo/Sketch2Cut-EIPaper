

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{候选部件搜索}
本章中，我们介绍如何从未做预分割的模型数据库内快速、精确地搜索出与代理模型相匹配的三维候选部件。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{代理模型创建}
与~\cite{Funkhouser2004}类似，我们使用三维代理模型从数据库内搜索部件并辅助部件组合。
我们提供三种基本代理模型，使用户更容易表达造型意图。
当然，用户输入的草图也可直接用于部件搜索。

我们提供三种基本代理模型（如图\ref{FigProxy}）：广义球体，广义柱体，薄板模型。
广义球体通过Nealen等人~\cite{AndrewNealen2007}的方法生成。
广义柱体通过两笔生成：在当前模型上画一个圆圈表示柱体底座，然后画一条曲线指示柱体中心线。中心线位于用户视线方向与圆球起点定义的空间平面上。
广义柱体的两端可以放缩，得到圆锥或圆台。
要生成薄板模型，用户首先在当前模型上画一条曲线，再画出轮廓线。
该轮廓线位于用户视线方向与曲线起点定义的空间平面上。
我们的系统允许用户对代理模型施加各种操作，包括放缩，切割，变形等。
%--------------------------
\begin{figure}\centering
\includegraphics[width=\linewidth]{./Mat/Proxy.pdf}
\caption{三种基础代理模型。（a）广义球体。（b）广义柱体。（c）薄板模型。}\label{FigProxy}
\end{figure}

用户创建代理模型过程中，系统记录每次操作的视角及操作前后代理模型的体积变化。
代理模型建成后，我们提取代理模型在体积变化最大的视角下的二维轮廓（该轮廓称为主轮廓），用于描述用户的建模意图。
体积变化次之的视角下提取的轮廓是副轮廓，用于三维候选部件排序。最后，我们提取主、副轮廓的描述符（采样距离为9）。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{候选部件搜索}
给一个三维代理模型与一个数据库模型，我们的目标是在数据库模型上找到与代理模型最相似的部分（称为候选三维部件）。
首先，我们通过代理模型轮廓与数据库模型轮廓做匹配得到候选轮廓段。
然后，基于候选轮廓段与数据库模型的超面片图表示提取三维候选部件。

%--------------------------
\textbf{候选轮廓段搜索} 依据采样距离，我们将一个数据库模型的所有轮廓与代理模型主轮廓的匹配结果组织为$\left\| {{\Theta _M}} \right\|$个匹配结果组。
为了选择出候选轮廓段，我们首先选择出最佳匹配结果组。
给定代理轮廓$C$，数据库模型轮廓$\Gamma_M$及其采样距离$\Theta_M$，最佳匹配结果组选择问题定义为：
\[\mathop {\min }\limits_{{\theta _i} \in {\Theta _M}} \sum {J_{{\theta _i}}^j} ,\]
其中$J_{\theta_i}^j$表示在采样距离$\theta_i$下最好的第$j$个匹配结果的匹配分数（见公式（\ref{EquCtourMatch}））。
我们从最佳匹配结果组内选择出最好的前3个匹配结果，并由此得到候选轮廓段。

%--------------------------
\subsubsection{三维模型的超面片图表示}
我们在预处理阶段为数据库模型建立超面片图表示形式~\cite{GuoSGP2016}。
图上顶点表示超面片。图上边描述超面片间相邻关系。边上权重表示相邻超面片合并成更大超面片的先验概率（如图~\ref{FigSFG}）。
%--------------------------
\begin{figure}\centering
\includegraphics[width=\linewidth]{./Mat/SFG.pdf}
\caption{三维模型超面片图建立过程示意图。给一个Deer模型（a），我们将它分割成200个超面片（b）。
一个超面片是超面片图的一个顶点。相邻超面片由带权重的边连接（c）。}\label{FigSFG}
\end{figure}

为了建立超面片图，我们首先将模型分割成200个片断~\cite{Huang2011}。一个片断视一个超面片。相邻超面片用一条边相连。

为了计算边权重，我们对三维模型做多次Randomized Segmentation~\cite{Golovinskiy2008}。
对每一次分割结果，我们为每个超面片建立一个直方图，描述该超面片属于各分割片断的概率（如图\ref{FigSFDist}）。超面片$s$针对分割部件$g$的直方条$h_s^g$定义为：
\[h_s^g = \frac{{\sum\limits_{f \in F\left( g \right) \cap F\left( s \right)} {A\left( f \right)} }}{{\sum\limits_{f \in F\left( s \right)} {A\left( f \right)} }},\]
其中，$F \left(x \right)$是属于$x$的面片集合，$A \left( f \right)$是面片$f$的面积。相邻面片$s$与$s'$位于同一部件的概率$P \left(s, s' \right)$为两超面片的直方图$H$与$H'$的${\chi ^2}$的距离：
\[P\left( {s,s'} \right) = 1 - {\chi ^2}\left( {H,H'} \right) = 1 - \frac{1}{2}\sum\limits_{{g_i} \in G} {\frac{{{{\left( {h_s^{{g_i}} - h_{s'}^{{g_i}}} \right)}^2}}}{{{{\left( {h_s^{{g_i}} + h_{s'}^{{g_i}}} \right)}^2}}}} ,\]
其中$G = \left\{ {{g_i}|1 \le i \le N} \right\}$是一次分割结果的所有片断。为了得到超面片图上边的权重，我们首先将两超面片在不同分割结果上的概率累加，再通过分割次数归一化。
%--------------------------
\begin{figure}\centering
\includegraphics[width=\linewidth]{./Mat/SFDist.pdf}
\caption{超面片在分割片断上的分布示意图。$s_0$，$s_1$和$s_2$是超面片。$g_0$，$g_1$与$g_2$是通过Randomized Segmentation~\cite{Golovinskiy2008}得到的分割片断。}\label{FigSFDist}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{候选部件搜索}
给一个候选轮廓及数据库模型，我们的目标是在该数据库模型上找到与候选轮廓最匹配的三维候选部件。
我们将三维候选部件的搜索问题形式化为超面片图上的子图搜索问题（如图~\ref{FigPartRetr}）。类似~\cite{GuoSGP2016}，该问题的目标函数如下：
\[\mathop {\min }\limits_L \left( {\sum\limits_{{v_i} \in V} {{D_{{v_i}}}\left( {{L_{{v_i}}}} \right) + \sum\limits_{\left( {{v_i},{v_j}} \right) \in E} {{S_{{v_i},{v_j}}}\left( {{L_{{v_i}}},{L_{{v_j}}}} \right)} } } \right),\]
其中，超面片图$G = \left( V, E \right)$，$V$表示顶点集合，$E$表示边集合。$L = \left\{ {{L_{{v_i}}}|{v_i} \in V} \right\}$是超面片图$G$的一个标记。
$D_{v_i} \left( L_{v_i} \right)$是数值项，计算将标志$L_{v_i}$置给$v_i$的能量耗费。$S_{v_i, v_j} \left(L_{v_i}, L_{v_j} \right)$是光滑项，鼓励相邻顶点$v_i$与$v_j$的空间一致性。
%--------------------------
\begin{figure}\centering
\includegraphics[width=1.0\linewidth]{./Mat/PartRetr.pdf}
\caption{三维候选部件搜索技术流程。给一个候选轮廓（（a）内红色部分），我们首先计算OSF obj-prob（b）。
然后，ISF obj-prob计算出来（c）。最后，三维候选部件的超面片通过graph-cut技术指认出来（d）。}\label{FigPartRetr}
\end{figure}

该目标函数采用min-cut/max-flow技术求解~\cite{Boykov2004}。n-links的容量是图内边的权重。t-links的容量定义为：
\[{D_{{v_i}}}\left( 1 \right) =  - \ln \Pr \left( {{I_{{v_i}}}|'obj'} \right),\]
\[{D_{{v_i}}}\left( 0 \right) =  - \ln \left( {1 - \Pr \left( {{I_{{v_i}}}|'obj'} \right)} \right),\]
其中，$Pr \left( I_{v_i} | 'obj' \right)$（obj-prob）表示$v_i$属于三维候选部件的概率。obj-prob的计算方法在接下来介绍。

对outer SF（OSF），其轮廓与模型轮廓有重合，其obj-prob通过其与候选三维部件的重合程度决定。对一个超面片图来讲，除了Outer SF就是Inner SF（ISF）。我们认为，在整张图内，OSF与ISF的obj-prob相一致。
因此，我们让OSF的obj-prob流入ISF，根据SF间的一致性。obj-prob流问题形式化为最小二乘问题：
\[{\bf{AX}} = {\bf{b}},\]
条件为：
\[{\bf{X}} \ge 0,\]
其中，${\bf{A}} = {\bf{I}} - {\bf{A}}'$，$\bf A'$是带权重的相邻矩阵，在ISFs之间。$\bf X$是ISF的概率。${\bf b} = {\bf B Y }$，其中$\bf B$是ISF与OSF间的带权相邻矩阵，
$\bf Y$是OSF的概率。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{候选部件排序}
我们基于候选部件与三维代理部件及当前模型间的兼容性对候选部件排序。在计算兼容性时，我们考虑如下因素：1）候选部件与代理部件间的二维投影的相似性；2）候选部件与三维代理部件间三维相似性；
3）候选部件与三维代理部件间的背景一致性。给一个候选部件$p$（$p$提取自数据库模型$M$），三维代理部件$B$，两者的兼容性定义如下：
\[T\left( {p,B} \right) = \omega {T_p}\left( {p,B} \right) + \xi {T_g}\left( {p,B} \right) + \psi {T_c}\left( {\Sigma ,{\rm X}} \right),\]
其中，$\Sigma$指$p$的背景区域，$\rm X$指$B$的背景区域，$\omega=0.8$，$\xi = 0.15$，$\psi = 0.05$。
$T_p \left( \cdot, \cdot \right)$计算三维模型的二维投影的相似性。$T_g \left( \cdot, \cdot \right)$计算三维模型的三维相似性。$T_c \left(, \right)$计算三维模型间的一致性。

\textbf{二维投影相似性} $T_p \left(p, B \right)$定义如下：
\[{T_p}\left( {p,B} \right) = {\omega _m}\frac{1}{{\mathop {\min }\limits_i J\left( {{{\bf{A}}_m},{{\bf{A}}_i}} \right)}} + {\omega _a}\frac{1}{{\mathop {\min }\limits_i J\left( {{{\bf{A}}_a},{{\bf{A}}_i}} \right)}},\]
其中，${\bf A}_m$与${\bf A}_a$是$p$的主轮廓与副轮廓的描述符，在最佳采样距离下。${\bf A}_i$是$B$在最佳采样距离下第$i$（$1 \le i \le T_M$）个视角下的轮廓的描述符。
$J \left(, \right)$的定义见公式（\ref{EquCtourMatch}）。$\omega_m = 0.9$，$\omega_a = 0.1$。

\textbf{三维模型相似性} $T_g \left(p, B \right)$定义如下：
\[{T_g}\left( {p,B} \right) = \alpha D\left( {p,B} \right) + \beta D\left( {B,p} \right),\]
其中，$D \left( \cdot, \cdot \right)$是largest common pointset measure~\cite{Aiger2008}。$\alpha = 0.9$，$\beta = 0.1$。

\textbf{背景一致性} ${T_c}\left( {\Sigma ,{\rm X}} \right)$定义如下：
\[{T_c}\left( {\Sigma ,{\rm X}} \right) = {T_g}\left( {{\rm X},\Sigma } \right).\]

兼容性分数值低于某阈值的候选部件被丢弃。留下的候选部件排序后建议给用户。如果需要多样性的部件建议，候选部件用Maximal Marginal Relevance criterion~\cite{Chaudhuri2010}技术重新排序。 