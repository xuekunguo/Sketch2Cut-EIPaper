

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{快速匹配数据结构}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{三维模型的超面片图表示}
我们在预处理阶段为数据库模型建立超面片图表示形式~\cite{GuoSGP2016}。图上顶点表示超面片。图上边描述超面片间空间相邻关系。边上权重表示相邻超面片合并成更大超面片的先验概率（如图~\ref{FigSFG}）。
%--------------------------
\begin{figure}\centering
\includegraphics[width=\linewidth]{./Mat/SFG.pdf}
\caption{三维模型超面片图建立过程示意图。给一个Deer模型（a），我们将它分割成200个超面片（b）。
一个超面片是超面片图的一个顶点。相邻超面片由带权重的边连接（c）。}\label{FigSFG}
\end{figure}

为了建立超面片图，我们首先将模型分割成200个片断~\cite{Huang2011}。一个片断视一个超面片。相邻超面片间用一条边相连。

为了计算边权重，我们对三维模型做多次Randomized Segmentation~\cite{Golovinskiy2008}。
对每一次分割结果，我们为每个超面片建立一个直方图，描述该超面片属于各分割片断的概率（如图\ref{FigSFDist}）。超面片$s$针对分割部件$g$的直方条$h_s^g$定义为：
\[h_s^g = \frac{{\sum\limits_{f \in F\left( g \right) \cap F\left( s \right)} {A\left( f \right)} }}{{\sum\limits_{f \in F\left( s \right)} {A\left( f \right)} }},\]
其中，$F \left(x \right)$是属于$x$的面片集合，$A \left( f \right)$是面片$f$的面积。相邻面片$s$与$s'$位于同一部件的概率$P \left(s, s' \right)$为两超面片的直方图$H$与$H'$的${\chi ^2}$的距离：
\[P\left( {s,s'} \right) = 1 - {\chi ^2}\left( {H,H'} \right) = 1 - \frac{1}{2}\sum\limits_{{g_i} \in G} {\frac{{{{\left( {h_s^{{g_i}} - h_{s'}^{{g_i}}} \right)}^2}}}{{{{\left( {h_s^{{g_i}} + h_{s'}^{{g_i}}} \right)}^2}}}} ,\]
其中$G = \left\{ {{g_i}|1 \le i \le N} \right\}$是一次分割结果的所有片断。为了得到超面片图上边的权重，我们首先将两超面片在不同分割结果上的概率累加，再通过分割次数归一化。
%--------------------------
\begin{figure}\centering
\includegraphics[width=\linewidth]{./Mat/SFDist.pdf}
\caption{超面片在分割片断上的分布示意图。$s_0$，$s_1$和$s_2$是超面片。$g_0$，$g_1$与$g_2$是通过Randomized Segmentation~\cite{GF08}得到的分割片断。}\label{FigSFDist}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{轮廓索引}\label{SubSecCtourIndex}
我们将三维模型局部匹配问题转化为多视角下的二维轮廓局部匹配问题。二维轮廓局部匹配通过比较代理轮廓与数据库模型轮廓求解。
我们为数据库模型提取$T_M = 14$个视角下的轮廓（boundary contours）~\cite{DeCarlo2003}，包括6个规范视角，8个角视角。
通过这种方式，我们得到三维模型的二维轮廓${\Gamma _M} = \left\{ {{S_i}|1 \le i \le {T_M}} \right\}$，$S_i$表示第$i$个视角下的轮廓。

\textbf{轮廓描述符} 我们采用角度矩阵做为轮廓描述符~\cite{GuoSGP2016,Riemenschneider2010}。
角度矩阵描述了轮廓上采样点间的空间分布。为了提取轮廓描述符，我们首先对轮廓等距离采样，得到$m$个采样点。对任意一对采样点$\left(b_i, b_j \right)$，我们计算其角度值$\alpha_{ij}$（如图~\ref{FigAngleDesc}）：
\[{\alpha _{ij}} = \left\{ {\begin{array}{*{20}{c}}
{\left\langle {\overline {{b_i}{b_j}} ,\overline {{b_i}{b_{i + \Delta }}} } \right\rangle } & {\text{if~} i < j,}  \\
{\left\langle {\overline {{b_i}{b_j}} ,\overline {{b_i}{b_{i - \Delta }}} } \right\rangle } & {\text{if~} i > j,}  \\
0 & {\text{if~} \left\| {i - j} \right\| \le \Delta }  \\
\end{array}} \right.\]
其中$\Delta=4$是偏移量，$\left\langle l_1, l_2 \right\rangle$代表直线$l_1$与$l_2$间的夹角。该角度值构成的矩阵$A$（$A_{ij}=\alpha_{ij}$）即为轮廓描述符。
%--------------------------
\begin{figure}\centering
\includegraphics[width=\linewidth]{./Mat/AngleDesc.pdf}
\caption{角度描述符示意图。}\label{FigAngleDesc}
\end{figure}

两轮廓$S$与$S'$的差异值定义为：
\begin{equation}\label{EquCtourMatch}
J\left( {{\bf{A}},{\bf{A}}'} \right) = \mathop {\min }\limits_k \frac{1}{{{N^2}}}\sum\limits_{i = 0}^{N - 1} {\sum\limits_{j = 0}^{N - 1} {{{\left( {{{\bf{A}}_{\left[ {k + i,k + j} \right]}} - {\bf{A}}{'_{\left[ {i,j} \right]}}} \right)}^2}} } ,
\end{equation}
其中$\bf A$是$S$的轮廓描述符，大小为$M \times M$；${\bf A}'$是$S$的轮廓描述符，大小为$N \times N$（$N \le M$）。
${\bf A}_{\left[,\right]}$是矩阵的元素。

\textbf{建立轮廓索引} 在我们的方法中一个最大的挑战是快速地在数据库模型内找到与代理部件轮廓相匹配的轮廓。
直接一个接一个地比较代理部件轮廓与各模型的轮廓明显不可行，因为匹配时间会随数据库模型数量的增大而急剧增大。
因此，我们需要设计一个具有可扩展性的方法。我们开发了一个分层的索引数据库结构，为了数据库内模型轮廓，来加速模型匹配过程。

对数据库模型的每一个轮廓，我们按不同的采样距离等距采样，得到一组采样轮廓，每个采样轮廓称为一个点轮廓。
我们首先建立一个$k$NN图~\cite{Seb2002}，为了数据库内所有模型轮廓，基于它们的匹配程度。 图的顶点表示模型轮廓，对每一个顶点，我们将与之最相似的$k = 30$个顶点连接在一起。匹配分数及两轮廓内采样点间的对应关系存储在对应边上。

接着，我们在图上采样出一组种子点。我们随机地选择一个顶点做为种子，然后采用最好优化（best-first search）方法遍历该图。
当前顶点与种子点的匹配分数高于一个阈值$\delta_c = 0.7$时，当前顶点做为种子点。我们以当前顶点为起点开始遍历过程。
该遍历过程不断重复，直至所有顶点被访问到。通过这种方式，我们从$k$NN图内采样出一组种子点。

为了加速建立轮廓层次索引数据结构，我们首先过滤掉不相似的三维模型，通过比较它们的三维模型分布（3D shape distribution）~\cite{Funkhouser2003}。
接着，索引在最相似的80个模型的轮廓上建立。

\textbf{轮廓层次索引辅助轮廓局部匹配} 在运行中，给一个代理模型轮廓$E_C$，我们首先将它与所有的种子轮廓相匹配。匹配结果存在在优先队列内，并按匹配分数升序排列。
我们接着遍历$k$NN图通过最好优先方式。优先队列队顶出队，其邻居与$E_C$相比较，并入队。此时，我们利用预存储在图内边上的对应信息，可以快速地确定数据库轮廓上与$E_C$相
匹配的初始轮廓段。为了降低误差积累，我们进一步优化初始轮廓段，通过一个简单的初始轮廓段优化方法。具体地讲，我们首先将初始轮廓段延伸至$0.3N_{frag}$（$N_{frag}$是初始轮廓段的长度）。
接着，我们在延伸轮廓段上找到与$E_C$相匹配的部分，即为最终匹配轮廓段。为了进一步加速匹配过程，我们将匹配分数大于$0.9$的顶点去掉。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%在运行阶段，用户绘制代理模型轮廓，表达建模意图。
%系统快速从数据库内搜索出与代理模型相匹配的部件。
%我们的系统可以搜索出模型上任意部件，而不仅仅是预分割出的标准部件。
%因此，我们必须实时地处理数据库内每个模型，找到模型轮廓上与代理模型轮廓相匹配的部分。
%这要求一个极其快速的局部匹配方法。
%
%如果两个三维模型相似，那么他们从所有角度上看起来相似~\cite{Chen2003CGF}。我们发现该观察结论同样适用于代理模型与模型上的目标部件。
%因此，为了找到数据库模型上与代理模型相匹配的部分，我们可以比较代理模型与数据库模型间的二维轮廓。
%如果我们使用用户草图与数据库模型轮廓做局部匹配，一些与用户草图相似的部件将会被丢掉。
%如果我们直接将代理模型与数据库模型做局部匹配，这非常耗时，无法满足交互需求。
%因此，我们将代理模型轮廓与数据库模型在多个视角下的投影轮廓做局部匹配。
%在离线阶段，我们求得每一个数据库模型在很多视角下的边界轮廓。
%然后，问题转化为将代理模型轮廓与数据库模型轮廓做局部匹配的问题。
%
%实时地将如此多的数据库模型轮廓与代理模型轮廓做局部匹配异常困难。现有的算法，比如，分割树~\cite{Muja2014}、哈希存储~\cite{Andoni2008}、
%$K$NN图（$k$-nearest neighbors graph）~\cite{Wang2012}等，都针对全局匹配，而不是我们这里的局部匹配。
%
%为了快速找到数据库模型轮廓线与代理模型轮廓线相匹配的部分，我们提出一种新的数据结构，随机混合$K$NN图（RC-$K$NNG）。
%RC-$K$NNG的一个顶点代表数据库模型的一条边界轮廓线。然而，在我们的局部匹配问题中，单个轮廓可能在多个不同的段与查询轮廓相匹配（如图~\ref{FigCtourMatch}）。
%为了反映这一点，RC-$k$NNG允许一个顶点与多组$k$个最近顶点相连。与当前顶点相连的每一组顶点都与当前轮廓线上同一段相匹配。
%因此，通过与一条轮廓线的局部匹配结果，我们可以快速得到在其它轮廓线上的局部匹配结果。
%%--------------------------
%\begin{figure}\centering
%\includegraphics[width=\linewidth]{./Mat/CtourMatch.pdf}
%\caption[模型轮廓与查询轮廓匹配示意图]{查询轮廓与模型轮廓的不同部分相匹配。查询轮廓（a）在四个不同的段上与模型轮廓（b）相匹配（标为红色）。}\label{FigCtourMatch}
%\end{figure}
%
%\paragraph{创建RC-$k$NNG} 通过暴力方法计算模型轮廓上所有相似的轮廓段建立RC-$k$NNG过于耗时，不可行。
%因此，我们采用双随机策略建立RC-$k$NNG：
%\begin{enumerate}
%\item 我们首先为每条模型轮廓线在每个尺度下提取$n$（在我们的实验中，$n=6$）段（如图\ref{FigKNN}（a））。
%一个尺度由一组在模型轮廓上均匀分布的采样点构成：大尺度的采样间距小，包括更多采样点。
%我们采用3个尺度，即每条模型轮廓线上的采样点数分别为$50$，$150$，$250$。
%
%为了得到轮廓线上一段，我们随机选择一个不在其它轮廓段上的采样点。
%选择该采样点的概率是$p$（$p \propto c \cdot d$，$c$为该采样点的曲率，$d$为该采样点与最近的在其它轮廓段上的采样点的距离）。
%以该采样点为中心，分别向两侧取$10$个采样点，构成轮廓段。
%
%\item 我们采用多重随机分治策略~\cite{Wang2012}为所有的轮廓段建立$K$NN图（如图\ref{FigKNN}（b））。
%\end{enumerate}
%%--------------------------
%\begin{figure}\centering
%\includegraphics[width=\linewidth]{./Mat/KNN.pdf}
%\caption[随机混合$K$NN图]{随机混合$K$NN图。实线圆表示有效轮廓段，虚线圆表示无效轮廓段。给一条模型轮廓（做为随机混合$K$NN图的一个顶点），我们首先取得若干轮廓段（a）。
%然后，为每一条轮廓段找到最近邻居并在各轮廓段所属的轮廓间添加边（b）。最后，找到有效轮廓段并做聚类（c）。}\label{FigKNN}
%\end{figure}
%
%我们将所有的有效轮廓段添加到全局有效轮廓段列表内。有效轮廓段指该轮廓段与它最近的$k$个邻居间距（见\ref{SubSecCD}节）低于阈值$\varepsilon = 0.85$。
%然后，我们对全局有效轮廓段列表内的轮廓段做聚类，聚类代表是聚类中心轮廓段。这些代表做为种子轮廓用于查询阶段（如图\ref{FigKNN}（c））。
%聚类个数为${N \mathord{\left/ {\vphantom {N {80}}} \right. \kern-\nulldelimiterspace} {80}}$（$N$是全局有效轮廓段列表内轮廓段的个数）。

%查询轮廓（代理模型轮廓）整体做为一个轮廓段。模型轮廓在每个尺度下都由若干轮廓段构成（见\ref{SecRCKNNG}节）。
%模型轮廓的轮廓段与查询轮廓相匹配，从而得到查询轮廓与模型轮廓的局部匹配。为了比较两个轮廓段，我们为它们计算轮廓描述符。类似~\cite{GuoSGP2016}，我们采用Riemenschneider等人~\cite{Riemenschneider2010}提出的角度矩阵做为轮廓描述符。
%该描述符描述了轮廓段上采样点间的空间分布。我们为轮廓提取描述符，在不同的采样距离下$\Theta  = \left\{ {3,6,9,12,15} \right\}$提取轮廓描述符。
%一个轮廓段内有$m$个采样点。给一对采样点$\left(b_i, b_j \right)$，我们计算角度值$\alpha_{ij}$：
%\[{\alpha _{ij}} = \left\{ {\begin{array}{*{20}{c}}
%{\left\langle {\overline {{b_i}{b_j}} ,\overline {{b_i}{b_{i + \Delta }}} } \right\rangle } & {\text{if~} i < j,}  \\
%{\left\langle {\overline {{b_i}{b_j}} ,\overline {{b_i}{b_{i - \Delta }}} } \right\rangle } & {\text{if~} i > j,}  \\
%0 & {\text{if~} \left\| {i - j} \right\| \le \Delta }  \\
%\end{array}} \right.\]
%其中，$\delta=2$是偏移量，$\left\langle l_1, l_2 \right\rangle$代表直线$l_1$与$l_2$间的夹角。轮廓描述符即为该角度值构成的矩阵$A$（$A_{ij}=\alpha_{ij}$）。
%两个轮廓段$S$与$T$间的距离是两轮廓段的角度矩阵$A^S$与$A^T$的欧式距离：
%\[ D(S, T) = \frac{1}{m^2} \sum_{i = 1}^m \sum_{j = 1}^m \left( A^S_{ij} - A^T_{ij} \right)^2\]
